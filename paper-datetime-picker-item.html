<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../iron-icon/iron-icon.html'>
<link rel='import' href='../paper-item/paper-icon-item.html'>
<link rel='import' href='../paper-item/paper-item.html'>
<link rel='import' href='../paper-item/paper-item-body.html'>
<link rel='import' href='../paper-ripple/paper-ripple.html'>
<link rel='import' href='../paper-styles/paper-styles.html'>
<link rel='import' href='paper-date-picker-edit-dialog.html'>
<link rel='import' href='paper-time-picker-edit-dialog.html'>

<script src='../moment/min/moment-with-locales.min.js'></script>

<dom-module id='paper-datetime-picker-item'>

	<style>
		:host {
			@apply(--layout-horizontal);
		}

		.icon {
			color: var(--disabled-text-color);
		}

		:host[has-no-date] .text {
			color: var(--secondary-text-color);
		}
	</style>

	<template>
		<paper-icon-item on-tap='_edit'>
			<paper-ripple fit></paper-ripple>
			<iron-icon icon=[[icon]] item-icon class='icon'></iron-icon>
			<paper-item-body class='text'>[[_getPrettyDate(date)]]</paper-item-body>
		</paper-icon-item>
		<paper-item class='flex' on-tap='_editTime'>
			<paper-ripple fit></paper-ripple>
			[[_showTime]]
		</paper-item>
	</template>

</dom-module>

<script>

(function() {

	Polymer({
		is: 'paper-datetime-picker-item',
		properties: {
			date: {
				type: Date,
				value: null,
				notify: true
			},
			timeZoneOffset: {
				type: String,
				computed: '_computeTimeZoneOffset(date)',
			},
			icon: String,

			hasNoDate: {
				type: Boolean,
				computed: '_computeHasNoDate(date)',
				reflectToAttribute: true
			},
			_showTime: {
				type: String,
				computed: '_computeShowTime(date)'
			}
		},

		// Private methods
		_edit: function() {
			var dialog = document.createElement('paper-date-picker-edit-dialog');

			// Wait until dialog is created before the properties can be set
			// @see http://stackoverflow.com/a/31482376
			this.async(function() {
				// Initialize dialog with the current date (default to today to avoid exception)
				dialog.date = this.date || new Date();

				// Capture date if the user saved the dialog
				dialog.addEventListener('paper-date-picker-edit-dialog-save', function(e) {
					var newDate = e.detail;

					// If there is already a time picked, don't change it
					if (typeof this.date !== 'undefined' && this.date !== null) {
						newDate.setHours(this.date.hour, this.date.minute);
					}
					this.date = newDate;

					// Inform listener of 'change' events when the date was changed
					this.fire('change', { value: this.date });
				}.bind(this));

				dialog.open();
			});
		},
		_getPrettyDate: function(date) {
			if (!date) {
				return 'Add a date';
			}

			// Use momentjs.com library to format the date
			return moment(date).format('ll');
		},

		// Time related private methods
		_computeShowTime: function(date) {
			if (!date) {
				return '';
			}

			return moment(date).format('hh:mm A');
		},
		_editTime: function() {
			var dialog = document.createElement('paper-time-picker-edit-dialog');
			// Wait until dialog is created before the properties can be set
			// @see http://stackoverflow.com/a/31482376
			this.async(function() {
				// Initialize dialog with the current time
				dialog.time = this._showTime;

				// Capture date if the user saved the dialog
				dialog.addEventListener('paper-time-picker-edit-dialog-save', function(e) {
					// time object containing hour, minute and formatted 'HH:mm A' string
					var time = e.detail;
					this.date.setHours(time.hour, time.minute);

					//TODO: propagate the change to the _showTime field to display the new time
					//this._showTime = this.time.formatted

					// Inform listener of 'change' events when the date was changed
					this.fire('change', { value: this.date });
				}.bind(this));

				dialog.open();
			}.bind(this));
		},
		_computeHasNoDate: function(date) {
			return !date;
		},

		// Timezone handling
		_computeTimeZoneOffset: function(date) {
			// Use momentjs.com library to obtain the timezone in +0100 format
			return moment.parseZone(date).format('ZZ');
		},
	});

})();

</script>
