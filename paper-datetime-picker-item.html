<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../iron-icon/iron-icon.html'>
<link rel='import' href='../paper-item/paper-icon-item.html'>
<link rel='import' href='../paper-item/paper-item.html'>
<link rel='import' href='../paper-item/paper-item-body.html'>
<link rel='import' href='../paper-ripple/paper-ripple.html'>
<link rel='import' href='../paper-styles/paper-styles.html'>
<link rel='import' href='paper-date-picker-edit-dialog.html'>
<link rel='import' href='paper-time-picker-edit-dialog.html'>
<link rel='import' href='paper-date-picker-behaviors.html'>

<dom-module id='paper-datetime-picker-item'>

	<style>
		:host {
			@apply(--layout-horizontal);
		}

		.icon {
			color: var(--disabled-text-color);
		}

		.item[has-no-date] .text {
			color: var(--secondary-text-color);
		}
	</style>

	<template>
		<paper-icon-item on-tap='_editDate' class='flex item' has-no-date$=[[!date]]>
			<paper-ripple fit></paper-ripple>
			<iron-icon icon=[[icon]] item-icon class='icon'></iron-icon>
			<paper-item-body class='text'>[[_getFormattedDate(date)]]</paper-item-body>
		</paper-icon-item>
		<paper-item class='flex' on-tap='_editTime' hidden=[[!date]]>
			<paper-ripple fit></paper-ripple>
			[[_getFormattedTime(date)]]
		</paper-item>
	</template>

</dom-module>

<script>

(function() {

	Polymer({
		is: 'paper-datetime-picker-item',
		properties: {
			icon: String
		},

		behaviors: [
			Polymer.PaperDatePickerItemBehavior
		],

		// Private methods
		_editDate: function() {
			var dialog = document.createElement('paper-date-picker-edit-dialog');

			// Wait until dialog is created before the properties can be set
			// @see http://stackoverflow.com/a/31482376
			this.async(function() {
				// Initialize dialog with the current date (default to today to avoid exception)
				dialog.date = this.date || new Date();

				// Capture date if the user saved the dialog
				dialog.addEventListener('paper-date-picker-edit-dialog-save', function(e) {
					var newDate = e.detail;

					// If there is already a time picked, don't change it
					// TODO: this piece is only necessary because of this issue with the date picker: https://github.com/bendavis78/paper-date-picker/issues/50
					// Once issue is solved this method can be replaced by PaperDatePickerItemBehaviorImpl._edit
					if (typeof this.date !== 'undefined' && this.date !== null) {
						var hours = moment(this.date).format('HH');
						var minutes = moment(this.date).format('mm');
						newDate.setHours(hours, minutes);
					}
					this.date = newDate;

					// Inform listener of 'change' events when the date was changed
					this.fire('change', { value: this.date });
				}.bind(this));

				dialog.open();
			});
		},
		// Time related private methods
		_editTime: function() {
			this._edit('paper-time-picker-edit-dialog');
		}
	});

})();

</script>
